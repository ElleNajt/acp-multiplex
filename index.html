<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>ACP</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro", system-ui, sans-serif;
  background: #0d1117; color: #e6edf3;
  height: 100dvh; display: flex; flex-direction: column;
}
#status {
  padding: 8px 16px; font-size: 13px; color: #8b949e;
  border-bottom: 1px solid #21262d; flex-shrink: 0;
}
#status.connected { color: #3fb950; }
#status.error { color: #f85149; }
#messages {
  flex: 1; overflow-y: auto; padding: 16px;
  -webkit-overflow-scrolling: touch;
}
.msg { margin-bottom: 16px; line-height: 1.5; }
.msg.agent { color: #e6edf3; }
.msg.thought { color: #8b949e; font-style: italic; }
.msg.user { color: #79c0ff; }
.msg.system { color: #8b949e; font-size: 13px; }
.msg.tool { color: #d2a8ff; font-size: 13px; }
.msg pre {
  background: #161b22; border: 1px solid #21262d;
  border-radius: 6px; padding: 12px; margin: 4px 0;
  overflow-x: auto; font-size: 13px;
}
.msg code { font-family: "SF Mono", Menlo, monospace; }
#input-area {
  border-top: 1px solid #21262d; padding: 12px 16px;
  display: flex; gap: 8px; flex-shrink: 0;
  padding-bottom: max(12px, env(safe-area-inset-bottom));
}
#prompt {
  flex: 1; background: #161b22; border: 1px solid #30363d;
  border-radius: 8px; color: #e6edf3; padding: 10px 14px;
  font-size: 16px; font-family: inherit; resize: none;
  min-height: 44px; max-height: 120px;
}
#prompt:focus { outline: none; border-color: #58a6ff; }
#send {
  background: #238636; border: none; border-radius: 8px;
  color: white; padding: 10px 20px; font-size: 16px;
  cursor: pointer; flex-shrink: 0;
}
#send:active { background: #2ea043; }
#send:disabled { opacity: 0.5; }
</style>
</head>
<body>
<div id="status">Connecting...</div>
<div id="messages"></div>
<div id="input-area">
  <textarea id="prompt" rows="1" placeholder="Type a message..."></textarea>
  <button id="send" disabled>Send</button>
</div>
<script>
const messages = document.getElementById('messages');
const status = document.getElementById('status');
const prompt = document.getElementById('prompt');
const sendBtn = document.getElementById('send');

let ws, nextId = 10, sessionId = null, initialized = false;
let currentAgentMsg = null;

function addMsg(cls, html) {
  const d = document.createElement('div');
  d.className = 'msg ' + cls;
  d.innerHTML = html;
  messages.appendChild(d);
  messages.scrollTop = messages.scrollHeight;
  return d;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function connect() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host + '/ws');

  ws.onopen = () => {
    status.textContent = 'Connected';
    status.className = 'connected';
    // Wait for replayed messages (init, session/new, updates)
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    handleMessage(msg);
  };

  ws.onclose = () => {
    status.textContent = 'Disconnected';
    status.className = 'error';
    sendBtn.disabled = true;
    setTimeout(connect, 2000);
  };

  ws.onerror = () => {
    status.textContent = 'Connection error';
    status.className = 'error';
  };
}

function handleMessage(msg) {
  // Response to our requests
  if (msg.result !== undefined && msg.id !== undefined) {
    if (msg.result.agentInfo) {
      // Initialize response
      const info = msg.result.agentInfo;
      addMsg('system', 'Agent: ' + escHtml(info.name || '') + ' ' + escHtml(info.version || ''));
      initialized = true;
    }
    if (msg.result.sessionId) {
      sessionId = msg.result.sessionId;
      addMsg('system', 'Session: ' + escHtml(sessionId));
      sendBtn.disabled = false;
    }
    if (msg.result.stopReason) {
      currentAgentMsg = null;
      addMsg('system', '[' + escHtml(msg.result.stopReason) + ']');
    }
    return;
  }

  // Error
  if (msg.error) {
    addMsg('system', 'Error: ' + escHtml(msg.error.message || JSON.stringify(msg.error)));
    return;
  }

  // Notification
  if (msg.method === 'session/update' && msg.params) {
    const update = msg.params.update;
    if (!update) return;
    const kind = update.sessionUpdate;

    if (kind === 'agent_message_chunk') {
      if (!sessionId && msg.params.sessionId) sessionId = msg.params.sessionId;
      if (!sendBtn.disabled && sessionId) sendBtn.disabled = false;
      const text = update.text || '';
      if (!currentAgentMsg) {
        currentAgentMsg = addMsg('agent', '');
      }
      currentAgentMsg.innerHTML += escHtml(text);
    } else if (kind === 'agent_thought_chunk') {
      const text = update.text || '';
      addMsg('thought', escHtml(text));
    } else if (kind === 'tool_call') {
      currentAgentMsg = null;
      addMsg('tool', '[tool: ' + escHtml(update.toolName || '?') + ']');
    } else if (kind === 'tool_call_update') {
      addMsg('tool', '[' + escHtml(update.status || '?') + ']');
    } else if (kind === 'available_commands_update') {
      // First sign of life — enable input if we have a session
      if (sessionId) sendBtn.disabled = false;
    }
    return;
  }

  // Reverse call from agent — we're a secondary frontend, can't handle these
  if (msg.method && msg.id !== undefined) {
    addMsg('system', '[agent request: ' + escHtml(msg.method) + ']');
  }
}

function sendPrompt() {
  const text = prompt.value.trim();
  if (!text || !sessionId) return;

  addMsg('user', escHtml(text));
  currentAgentMsg = null;
  prompt.value = '';
  prompt.style.height = 'auto';

  ws.send(JSON.stringify({
    jsonrpc: '2.0',
    id: nextId++,
    method: 'session/prompt',
    params: { sessionId: sessionId, prompt: [{type: 'text', text: text}] }
  }));
}

sendBtn.onclick = sendPrompt;
prompt.onkeydown = (e) => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendPrompt(); }
};
prompt.oninput = () => {
  prompt.style.height = 'auto';
  prompt.style.height = Math.min(prompt.scrollHeight, 120) + 'px';
};

connect();
</script>
</body>
</html>
